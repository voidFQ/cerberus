<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>VOID</title>
  <style>
    body{margin:0;min-height:100vh;display:grid;place-items:center;font-family:Arial;background:#0b0b12;color:#fff}
    .box{max-width:820px;padding:28px;border:1px solid rgba(255,255,255,.12);border-radius:18px;background:rgba(255,255,255,.04)}
    .muted{opacity:.75;font-size:14px;line-height:1.5}
    .row{display:flex;gap:10px;flex-wrap:wrap;margin-top:14px}
    button{cursor:pointer;border:0;border-radius:12px;padding:10px 14px;font-weight:700}
    .ok{background:#6c5ce7;color:#fff}
    .no{background:rgba(255,255,255,.12);color:#fff}
    details{margin-top:14px}
    code{background:rgba(255,255,255,.08);padding:2px 6px;border-radius:6px}
  </style>
</head>
<body>
  <div class="box">
    <h1>VOID</h1>

    <p class="muted">
      На этом сайте используется аналитика посещений. <br>
      При согласии мы отправим владельцу сайта в Telegram следующие данные:
      <b>IP-адрес</b>, User-Agent (браузер/ОС), referrer, язык, часовой пояс, разрешение экрана, время и страницу визита.
    </p>

    <div class="row">
      <button class="ok" id="btnAccept">Согласен</button>
      <button class="no" id="btnDecline">Не согласен</button>
    </div>

    <p class="muted" id="status" style="margin-top:12px;"></p>

    <details>
      <summary>Политика (кратко)</summary>
      <p class="muted">
        1) Цель: подсчёт визитов и базовая аналитика. <br>
        2) Состав данных: IP, UA, referrer, язык/таймзона, экран, страница, время. <br>
        3) Передача: в Telegram владельцу сайта. <br>
        4) Основание: ваше согласие (кнопка “Согласен”). <br>
        5) Отзыв согласия: удалите cookies для этого сайта или нажмите “Не согласен”. <br>
        6) Хранение: сообщения сохраняются в Telegram на стороне владельца.
      </p>
    </details>
  </div>

  <script>
    const statusEl = document.getElementById("status");
    const KEY = "visit_consent_v1";

    function setStatus(t){ statusEl.textContent = t; }

    async function sendVisit() {
      const payload = {
        page: location.pathname + location.search,
        title: document.title,
        referrer: document.referrer || "",
        lang: navigator.language || "",
        tz: Intl.DateTimeFormat().resolvedOptions().timeZone || "",
        screen: `${screen.width}x${screen.height}`,
        ua: navigator.userAgent,
        ts: new Date().toISOString()
      };

      const r = await fetch("/track", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      });

      if (!r.ok) {
        const t = await r.text().catch(()=> "");
        throw new Error("Track failed: " + (t || r.status));
      }
    }

    async function accept() {
      localStorage.setItem(KEY, "yes");
      setStatus("Ок, спасибо. Отправляю визит…");
      try {
        await sendVisit();
        setStatus("Готово ✅ (визит отправлен владельцу в Telegram)");
      } catch (e) {
        setStatus("Ошибка отправки ❌ " + e.message);
      }
    }

    function decline() {
      localStorage.setItem(KEY, "no");
      setStatus("Ок. Данные отправляться не будут.");
    }

    document.getElementById("btnAccept").addEventListener("click", accept);
    document.getElementById("btnDecline").addEventListener("click", decline);

    // Если уже согласился раньше — отправляем автоматически (один раз на загрузку)
    (async () => {
      if (localStorage.getItem(KEY) === "yes") {
        setStatus("Вы ранее дали согласие. Отправляю визит…");
        try {
          await sendVisit();
          setStatus("Готово ✅ (визит отправлен)");
        } catch (e) {
          setStatus("Ошибка отправки ❌ " + e.message);
        }
      } else if (localStorage.getItem(KEY) === "no") {
        setStatus("Вы отказались. Данные не отправляются.");
      } else {
        setStatus("Нужно ваше согласие для отправки аналитики.");
      }
    })();
  </script>
</body>
</html>
